raft论文中指出，leader需要保存额外的易失性状态，用于追踪fowller的复制状态：


> ![img.png](img.png)

|              |                                                  |
|:------------:|:------------------------------------------------:|
|      参数      |                        解释                        |
| nextIndex[]  | 对于每一台服务器，发送到该服务器的下一个日志条目的索引（初始值为领导人最后的日志条目的索引+1） |
| matchIndex[] |   对于每一台服务器，已知的已经复制到该服务器的最高日志条目的索引（初始值为0，单调递增）    |

在etcd中，leader维护了一个follower id到Progress对象的映射，leader用它来追踪所有fowller的状态。
其对raft论文中所提及的leader需要保存的额外状态进行了拓展
，主要功能及其字段描述如下：

- 追踪follower的日志复制进度

|           字段           |                                                                    解释                                                                     |
|:----------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------:|
|      Match uint64      |                                                          追随者的日志与领导者的日志相匹配的位置的索引                                                           |   
|      Next uint64       |                                                           发送给follower的下一条日志的索引                                                            |  
|   sentCommit uint64    |                         sentCommit 是发送给跟随者的最高提交索引。<br/>通常，它是单调的，但在某些情况下会出现倒退，例如当State转换为 `StateProbe` 或收到跟随者的拒绝时。                         |   
| PendingSnapshot uint64 | 当领导者意识到这个节点需要一个快照时候，用于跟踪最新日志的index。 当有待处理的快照时，向跟随者的复制将暂停。  如果领导者从其收到 MsgAppResp（当跟随者应用快照时会发出这样的 MsgAppResp)，follwer的状态转换为`StateReplicate` |  

- 限流

|          字段           |                                                                                                    解释                                                                                                    |
|:---------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Inflights *Inflights  | Inflights是正在发送的消息的滑动窗口,每一个滑动窗口包含一个或多个日志。<br/>当领导者发出消息时，最后一个条目的索引应该添加到 inflights 中。<br/>当领导者收到回复时，应该通过使用最后收到的条目的索引调用 inflights.FreeLE 来释放先前的 inflights。<br/>inflight 有效地限制了发送中消息的数量，以及每个 Progress 可以使用的带宽 |   
| MsgAppFlowPaused bool |                                                  当发送给该节点的 MsgApp 流受到限制时，将 MsgAppFlowPaused转换为true。这种情况发生在 StateProbe 或 Inflights 饱和的 StateReplicate 中。                                                   | 

- 追踪follower的状态

|        字段         |                                                                                                 解释                                                                                                 |
|:-----------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|  State StateType  | 	在StateProbe中，leader每个心跳间隔最多发送一条复制消息,用于探讨了追随者的实际进展。<br/>在StateReplicate中，leader乐观地增加next到发送Replicate消息时发送的最新条目之后。这是一种优化状态，用于将日志条目快速复制到follower。<br/>在StateSnapshot中，leader之前应该已经发送了快照，并停止发送任何复制消息。 |   
| RecentActive bool |                                                                                  如果节点最近处于活动状态，则 RecentActive 为真。                                                                                   | 

Processer的状态转换如下所示。

```
                            +--------------------------------------------------------+          
                            |                  send snapshot                         |          
                            |                                                        |          
                  +---------+----------+                                  +----------v---------+
              +--->       probe        |                                  |      snapshot      |
              |   |  max inflight = 1  <----------------------------------+  max inflight = 0  |
              |   +---------+----------+                                  +--------------------+
              |             |            1. snapshot success                                    
              |             |               (next=snapshot.index + 1)                           
              |             |            2. snapshot failure                                    
              |             |               (no change)                                         
              |             |            3. receives msgAppResp(rej=false&&index>lastsnap.index)
              |             |               (match=m.index,next=match+1)                        
receives msgAppResp         |
(next=match+1)(rej=true)    |                                                                  
              |             |                                                                   
              |             |                                                                   
              |             |                                                                   
              |             |   receives msgAppResp(rej=false&&index>match)                     
              |             |   (match=m.index,next=match+1)                                    
              |             |                                                                   
              |             |                                                                   
              |             |                                                                   
              |   +---------v----------+                                                        
              |   |     replicate      |                                                        
              +---+  max inflight = n  |                                                        
                  +--------------------+                                                        
```


